#!/bin/bash

# Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð»Ñ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ð¸ SSL ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ð²

set -e

echo "ðŸ”’ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° SSL Ð´Ð»Ñ 404tears.kz"

# Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¸Ð· .env
if [ -f .env ]; then
    export $(cat .env | grep -v '^#' | xargs)
fi

DOMAIN=${DOMAIN:-404tears.kz}
DOMAIN_WWW=${DOMAIN_WWW:-www.404tears.kz}
EMAIL=${LETSENCRYPT_EMAIL:-admin@404tears.kz}

echo "Ð”Ð¾Ð¼ÐµÐ½: $DOMAIN"
echo "Email: $EMAIL"

# Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ HTTP ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ Ð´Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð°
echo "ðŸ“ ÐŸÐµÑ€ÐµÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ð½Ð° HTTP ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ..."
cp nginx/nginx-http.conf nginx/nginx.conf

# ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ frontend
echo "ðŸ”„ ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº frontend..."
docker-compose -f docker-compose.prod.yml restart frontend || docker-compose -f docker-compose.prod.yml up -d frontend

# Ð–Ð´ÐµÐ¼ Ð¿Ð¾ÐºÐ° nginx Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑÑ
echo "â³ ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ Ð·Ð°Ð¿ÑƒÑÐºÐ° nginx..."
sleep 10

# ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ SSL ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚
echo "ðŸ“œ ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ SSL ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð° Ð¾Ñ‚ Let's Encrypt..."
docker-compose -f docker-compose.prod.yml run --rm certbot certonly \
    --webroot \
    --webroot-path=/var/www/certbot \
    --email $EMAIL \
    --agree-tos \
    --no-eff-email \
    -d $DOMAIN \
    -d $DOMAIN_WWW

if [ $? -eq 0 ]; then
    echo "âœ… SSL ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½!"
    
    # Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ HTTPS ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ
    echo "ðŸ“ ÐŸÐµÑ€ÐµÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ð½Ð° HTTPS ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ..."
    git checkout nginx/nginx.conf 2>/dev/null || {
        # Ð•ÑÐ»Ð¸ git Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½, ÑÐ¾Ð·Ð´Ð°ÐµÐ¼ HTTPS ÐºÐ¾Ð½Ñ„Ð¸Ð³ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ
        cat > nginx/nginx.conf << 'EOF'
# HTTP server - redirect to HTTPS
server {
    listen 80;
    server_name 404tears.kz www.404tears.kz;
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }
    location / {
        return 301 https://$host$request_uri;
    }
}

# HTTPS server
server {
    listen 443 ssl http2;
    server_name 404tears.kz www.404tears.kz;
    ssl_certificate /etc/letsencrypt/live/404tears.kz/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/404tears.kz/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    root /usr/share/nginx/html;
    index index.html;
    location / {
        try_files $uri $uri/ /index.html;
    }
    location /api {
        proxy_pass http://backend:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
EOF
    }
    
    # ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ frontend Ñ SSL
    echo "ðŸ”„ ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº frontend Ñ SSL..."
    docker-compose -f docker-compose.prod.yml restart frontend
    
    # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ certbot Ð´Ð»Ñ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ
    echo "ðŸ”„ Ð—Ð°Ð¿ÑƒÑÐº Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ð²..."
    docker-compose -f docker-compose.prod.yml up -d certbot
    
    echo ""
    echo "âœ… SSL ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½!"
    echo "ðŸŒ Ð¡Ð°Ð¹Ñ‚ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ð¿Ð¾ Ð°Ð´Ñ€ÐµÑÑƒ: https://$DOMAIN"
else
    echo "âŒ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ SSL ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚"
    echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ:"
    echo "  1. DNS Ð·Ð°Ð¿Ð¸ÑÐ¸ Ð´Ð»Ñ $DOMAIN Ð¸ $DOMAIN_WWW"
    echo "  2. ÐŸÐ¾Ñ€Ñ‚Ñ‹ 80 Ð¸ 443 Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚Ñ‹ Ð² firewall"
    echo "  3. Ð”Ð¾Ð¼ÐµÐ½ ÑƒÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÑ‚ Ð½Ð° IP ÑÑ‚Ð¾Ð³Ð¾ ÑÐµÑ€Ð²ÐµÑ€Ð°"
fi
